<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Road Intersection H5 Game – Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      background: #222;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      background: #3a3a3a;
      display: block;
    }
    .ui {
      width: 100%;
      max-width: 500px;
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }
    .controls-left {
      display: grid;
      grid-template-columns: repeat(3, 60px);
      gap: 6px;
    }
    .controls-right {
      display: grid;
      grid-template-columns: 80px;
      gap: 6px;
    }
    button {
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .arrow { background: #555; color: #fff; }
    .red { background: #c0392b; color: #fff; }
    .green { background: #27ae60; color: #fff; }
    .status { margin: 6px 0; }
  </style>
</head>
<body>
  <div class="status">Objective: Clear all vehicles</div>
  <canvas id="game" width="400" height="400"></canvas>

  <div class="ui">
    <div class="controls-left">
      <div></div>
      <button class="arrow" onclick="selectDir('top')">⬆</button>
      <div></div>
      <button class="arrow" onclick="selectDir('left')">⬅</button>
      <div></div>
      <button class="arrow" onclick="selectDir('right')">➡</button>
      <div></div>
      <button class="arrow" onclick="selectDir('bottom')">⬇</button>
      <div></div>
    </div>

    <div class="controls-right">
      <button class="red" onclick="setSignal('red')">RED</button>
      <button class="green" onclick="setSignal('green')">GREEN</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const CENTER = 200;
    const ROAD_W = 80;
    const LANE_OFFSET = 12;

    let selectedDir = 'top';

    const signals = {
      top: 'red',
      bottom: 'red',
      left: 'red',
      right: 'red'
    };

    const vehicles = {
      top: [],
      bottom: [],
      left: [],
      right: []
    };

    function spawnVehicle(dir) {
      vehicles[dir].push({ pos: 0, passed: false });
    }

    // random spawning
    setInterval(function () {
      const dirs = ['top', 'bottom', 'left', 'right'];
      const d = dirs[Math.floor(Math.random() * dirs.length)];
      spawnVehicle(d);
    }, 1200);

    function selectDir(dir) {
      selectedDir = dir;
    }

    function setSignal(color) {
      signals[selectedDir] = color;
    }

    function update() {
      Object.keys(vehicles).forEach(function (dir) {
        const list = vehicles[dir];
        list.forEach(function (v, i) {
          const stopLine = 80 + i * 26;
          if (!v.passed) {
            if (signals[dir] === 'green' || v.pos < stopLine - 2) {
              v.pos += 1.3;
            }
            if (v.pos > 170) {
              v.passed = true;
            }
          } else {
            v.pos += 2.2;
          }
        });
        vehicles[dir] = list.filter(function (v) {
          return v.pos < 300;
        });
      });
    }

    function drawRoad() {
      ctx.fillStyle = '#555';
      ctx.fillRect(0, CENTER - ROAD_W / 2, 400, ROAD_W);
      ctx.fillRect(CENTER - ROAD_W / 2, 0, ROAD_W, 400);

      ctx.strokeStyle = '#aaa';
      ctx.setLineDash([6, 6]);
      ctx.beginPath();
      ctx.moveTo(0, CENTER);
      ctx.lineTo(400, CENTER);
      ctx.moveTo(CENTER, 0);
      ctx.lineTo(CENTER, 400);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    function drawSignals() {
      const thickness = 8;

      Object.keys(signals).forEach(function (dir) {
        const color = signals[dir];
        ctx.fillStyle = color === 'green' ? '#0f0' : '#f00';

        if (dir === 'top') {
          ctx.fillRect(
            CENTER - ROAD_W / 2,
            CENTER - ROAD_W / 2 - thickness,
            ROAD_W / 2,
            thickness
          );
        }

        if (dir === 'bottom') {
          ctx.fillRect(
            CENTER,
            CENTER + ROAD_W / 2,
            ROAD_W / 2,
            thickness
          );
        }

        if (dir === 'left') {
          ctx.fillRect(
            CENTER - ROAD_W / 2 - thickness,
            CENTER,
            thickness,
            ROAD_W / 2
          );
        }

        if (dir === 'right') {
          ctx.fillRect(
            CENTER + ROAD_W / 2,
            CENTER - ROAD_W / 2,
            thickness,
            ROAD_W / 2
          );
        }
      });
    }

    function drawVehicles() {
      ctx.fillStyle = '#3498db';
      Object.keys(vehicles).forEach(function (dir) {
        vehicles[dir].forEach(function (v) {
          let x = CENTER;
          let y = CENTER;

          if (dir === 'top') {
            y = v.pos;
            x -= LANE_OFFSET;
          }
          if (dir === 'bottom') {
            y = 400 - v.pos;
            x += LANE_OFFSET;
          }
          if (dir === 'left') {
            x = v.pos;
            y += LANE_OFFSET;
          }
          if (dir === 'right') {
            x = 400 - v.pos;
            y -= LANE_OFFSET;
          }

          ctx.fillRect(x - 7, y - 7, 14, 14);
        });
      });
    }

    function draw() {
      ctx.clearRect(0, 0, 400, 400);
      drawRoad();
      drawSignals();
      drawVehicles();
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    loop();
  </script>
</body>
</html>